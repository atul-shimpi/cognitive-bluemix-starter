"id":"80d656be.72c268","type":"tab","label":"Main"},{"id":"3baff490.d817bc","type":"websocket-listener","z":"","path":"/ws/audio","wholemsg":"false"},{"id":"2292d2b1.e658be","type":"http in","z":"80d656be.72c268","name":"","url":"/audio","method":"get","swaggerDoc":"","x":90,"y":80,"wires":[["5744012e.76d55"]]},{"id":"5744012e.76d55","type":"template","z":"80d656be.72c268","name":"","field":"","fieldType":"msg","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n  <title>IBM Watson - Text To Speech</title>\n  <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js\"></script>\n  \n  <script type=\"text/javascript\">\n    var socketaddy = \"ws://\" + window.location.host + \"/ws/audio\";\n\n    $(document).ready(function(){\n      var output = document.getElementById('output')\n      $('#output').on('playing', function () {\n          $('#text').text('Playing audio.')\n          \n      });\n      $('#output').on('ended', function () {\n          $('#text').text('Waiting for audio...')\n          \n      });\n      sock = new WebSocket(socketaddy);\n      sock.onopen = function(){\n          $('#text').text('Waiting for audio...');\n          console.log(\"Connected websocket\");\n      };\n      sock.onerror = function(){ \n          console.log(\"Websocket error\"); \n      };\n      sock.onclose = function () {\n          $('#text').text('Not connected. Refresh the page?')\n      }\n      sock.onmessage = function(evt){\n        console.log(\"Websocket message\", evt); \n        output.src = window.URL.createObjectURL(evt.data);\n        output.play();\n      };\n    });\n  </script>\n  \n</head>\n<body style=\"font-size: 56px; font-family: helvetica; text-align: center; margin-top: 100px;\">\n  <div id=\"text\">Connecting...</div>\n  <audio id=\"output\"></audio>\n</body>\n</html>","x":233.60318756103516,"y":80.14283180236816,"wires":[["487c65ab.4c363c"]]},{"id":"487c65ab.4c363c","type":"http response","z":"80d656be.72c268","name":"","x":355.9739990234375,"y":80.46316528320312,"wires":[]},{"id":"33251094.6ab4a","type":"comment","z":"80d656be.72c268","name":"Send audio to speaker","info":"","x":121.5,"y":41,"wires":[]},{"id":"ceb39720.b7cb18","type":"ibmiot in","z":"80d656be.72c268","authentication":"boundService","apiKey":"","inputType":"evt","deviceId":"","applicationId":"","deviceType":"","eventType":"transcription","commandType":"","format":"JSON","name":"Device Transcription","service":"registered","allDevices":true,"allApplications":"","allDeviceTypes":true,"allEvents":"","allCommands":"","allFormats":"","qos":"0","x":130,"y":260,"wires":[["8fccaf3c.5ad75","f774096e.744c38","f6d4b99.18a1d48"]]},{"id":"8fccaf3c.5ad75","type":"function","z":"80d656be.72c268","name":"Set Transcription","func":"msg.transcription = msg.payload.body;\nmsg.date = new Date();\nreturn msg;","outputs":1,"noerr":0,"x":388.74999237060547,"y":263.7499876022339,"wires":[["bf3345fb.b73668","bd7718f4.d203b8"]]},{"id":"bf3345fb.b73668","type":"debug","z":"80d656be.72c268","name":"","active":true,"console":"false","complete":"transcription","x":676.2500038146973,"y":242.49999713897705,"wires":[]},{"id":"f774096e.744c38","type":"debug","z":"80d656be.72c268","name":"","active":true,"console":"false","complete":"false","x":367.5,"y":224.99999523162842,"wires":[]},{"id":"bd7718f4.d203b8","type":"function","z":"80d656be.72c268","name":"Timestamp","func":"currentDate = new Date();\nmsg.currentTime = currentDate.getHours() + \"h:\" + currentDate.getMinutes() + \"m:\" + currentDate.getSeconds() + \"s:\" + currentDate.getMilliseconds() + \"ms\";\nnode.warn(\"Recieved Text Transcription - \" + msg.currentTime);\nreturn msg;","outputs":1,"noerr":0,"x":662.4999923706055,"y":281.2499876022339,"wires":[[]]},{"id":"f6d4b99.18a1d48","type":"debug","z":"80d656be.72c268","name":"","active":true,"console":"false","complete":"deviceId","x":380.24999237060547,"y":189.2499876022339,"wires":[]},{"id":"45a14668.6974b8","type":"comment","z":"80d656be.72c268","name":"Conversation","info":"","x":94,"y":137,"wires":[]},{"id":"1934dd17.1a7203","type":"ibmiot out","z":"80d656be.72c268","authentication":"boundService","apiKey":"","outputType":"cmd","deviceId":"","deviceType":"+","eventCommandType":"audio","format":"JSON","data":"{}","qos":"","name":"Publish To Device","service":"registered","x":910.4047584533691,"y":412,"wires":[]},{"id":"81f8024b.fa256","type":"watson-text-to-speech","z":"80d656be.72c268","name":"","lang":"english","voice":"en-US_MichaelVoice","format":"audio/wav","x":125,"y":409.78537940979004,"wires":[["7b338be1.7ee3a4","1248d5a6.251cea"]]},{"id":"7b338be1.7ee3a4","type":"function","z":"80d656be.72c268","name":"Format Speech","func":"msg.payload = msg.speech;\nreturn msg;","outputs":1,"noerr":0,"x":376.48486328125,"y":411.33078956604004,"wires":[["2a8bf622.c20eaa","ca9d802b.ffee4"]]},{"id":"1248d5a6.251cea","type":"debug","z":"80d656be.72c268","name":"","active":true,"console":"false","complete":"payload","x":357.0002250671387,"y":355.4521837234497,"wires":[]},{"id":"2a8bf622.c20eaa","type":"function","z":"80d656be.72c268","name":"Publish audio to IoT","func":"msg.encode = new Buffer(msg.speech).toString(\"base64\");\nnode.warn(\"size: \" + msg.encode.length);\nnode.warn(\"data size: \"+msg.speech.length);\nvar response = [];\n\nresponse.push({payload: \"{\\\"type\\\":\\\"start\\\",\\\"id\\\":\\\"1\\\",\\\"size\\\":\"+msg.speech.length+\"}\", deviceId: msg.deviceId});\nvar pos = 0;\nvar numPackets = (msg.encode.length + 3500 - 1)/3500;\nfor (var index=0; index < numPackets; index++) {\n    var remLength = msg.encode.substring(pos).length;\n    var chunkLength;\n    if (remLength > 3500) {\n        chunkLength = 3500;\n    } else {\n        chunkLength = remLength;\n    }\n    var chunk = msg.encode.substring(pos,pos+chunkLength);\n    pos += 3500;\n    if (chunk !== \"\") {\n        response.push({payload: \"{\\\"type\\\":\\\"body\\\",\\\"id\\\":\\\"1\\\",\\\"body\\\":\\\"\"+chunk+\"\\\"}\", deviceId: msg.deviceId});\n    }\n}\nresponse.push({payload: \"{\\\"type\\\":\\\"end\\\",\\\"id\\\":\\\"1\\\"}\", deviceId: msg.deviceId});\nreturn [response];","outputs":1,"noerr":0,"x":662.5000343322754,"y":411.78560161590576,"wires":[["1934dd17.1a7203"]]},{"id":"ca9d802b.ffee4","type":"websocket out","z":"80d656be.72c268","name":"Audio Out","server":"3baff490.d817bc","client":"","x":570.6662635803223,"y":491.3808069229126,"wires":[]
